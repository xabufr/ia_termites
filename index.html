<!DOCTYPE html>
<html>
<head>
    <script type="text/javascript" src="./vector.js"></script>
    <script type="text/javascript" src="./world.js"></script>
    <script type="text/javascript" src="./agent.js"></script>
    <script type="text/javascript" src="./expert_system/rule.js"></script>
    <script type="text/javascript" src="./expert_system/fact.js"></script>
    <script type="text/javascript" src="./expert_system/engine.js"></script>
    <script type="text/javascript" src="./expert_system/expert_system.js"></script>
    <script type="text/javascript" src="./termite.js"></script>
    <script type="text/javascript" src="./wood_heap.js"></script>
    <script type="text/javascript" src="./wall.js"></script>
    <script type="text/javascript" src="./world_solver.js"></script>
    <script type="text/javascript" src="./random.js"></script>
    <script language="javascript">
        var world = null;
        var canvasElement = null;
        var canvasContext = null;

        var mainLoop = null;
        var lastUpdate = Date.now();
        var dt = 0;

        function updateTime() {
            var now = Date.now();
            dt = now - lastUpdate;
            lastUpdate = now;
        }
        var timeSinceLast = 0;
        var frameCount = 0;
        function update() {
            updateTime();
            timeSinceLast += dt;
            ++frameCount;
            if(timeSinceLast >= 1000) {
                console.log((frameCount / timeSinceLast) * 1000);
                frameCount = timeSinceLast = 0;
            }
            world.update(dt);
            canvasContext.clearRect(0, 0, canvasElement.width, canvasElement.height);
            world.draw(canvasContext);
        }

        function init() {

            canvasElement = document.getElementById("canvas");
            canvasContext = this.canvasElement.getContext("2d");

            world = new World(canvasElement.width, canvasElement.height);


            for (var i = 0; i < 5; i++) {
                var woodHeap = new WoodHeap();
                world.addAgent(woodHeap);
                woodHeap.moveTo(canvasElement.width * Math.random(),
                                canvasElement.height * Math.random());
            }

            for (var i = 0; i < 6; i++) {
                var wall = new Wall();
                world.addAgent(wall);
                wall.moveTo(canvasElement.width * Math.random(),
                                canvasElement.height * Math.random());
            }

            var solver = new WorldSolver(world);
            solver.solve();

            world.draw(canvasContext);

            var termites = [];
            for (var i = 0; i < 50; i++) {
                var termite = new Termite(canvasElement.width, canvasElement.height);
                termite.drawAStar = i === 0;
                world.addAgent(termite);
                termite.moveTo(canvasElement.width * Math.random(),
                                canvasElement.height * Math.random());
                termites.push(termite);
            }

            world.correctWalls();
            canvasElement.addEventListener('click', function (event) {
                var woodHeap = new WoodHeap();
                woodHeap.x = event.clientX - canvasElement.offsetLeft;
                woodHeap.y = event.clientY - canvasElement.offsetTop;
                world.addAgent(woodHeap)
            }, false);


            var fps = 60;
            mainLoop = setInterval(update, 1000 / fps);
            update();
        }
    </script>
</head>
<body onload="init()">
<canvas id="canvas" width="600" height="600" style="background-color:#eee; display:inline-block">

</canvas>
</body>
</html>